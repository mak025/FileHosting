@page
@model FileOverviewModel
@using System.Linq

@{
    ViewData["Title"] = "Filer";
}

@functions {
    // Returns CSS classes for the thumbnail based on file extension
    public string GetFileTypeClass(string fileName)
    {
        var ext = System.IO.Path.GetExtension(fileName)?.ToLower() ?? "";

        return ext switch
        {
            ".pdf" => "file-thumb pdf",
            ".doc" or ".docx" => "file-thumb doc",
            ".xls" or ".xlsx" => "file-thumb xls",
            ".ppt" or ".pptx" => "file-thumb ppt",
            ".png" or ".jpg" or ".jpeg" or ".gif" => "file-thumb image",
            ".txt" => "file-thumb txt",
            ".url" => "file-thumb url",
            ".zip" or ".rar" => "file-thumb zip",
            _ => "file-thumb generic"
        };
    }
}

<section class="file-overview">
    <!-- Header -->
    <header class="content-header">
        <div class="content-header-left">
            <h1>Alle filer</h1>
            <p class="content-subtitle">Oversigt over alle uploadede filer.</p>
        </div>

        <div class="content-header-right">
            <form method="get" class="search-form">
                <input type="text"
                       name="search"
                       placeholder="Søg i filer..."
                       value="@Request.Query["search"]"
                       class="search-input" />
                <button type="submit" class="btn btn-outline">Søg</button>
            </form>
        </div>
    </header>

    <!-- UPLOAD SECTION -->
    <section class="upload-section">
        <h2>Upload filer</h2>

        <form method="post"
              enctype="multipart/form-data"
              asp-page-handler="Upload"
              class="upload-form">
            <input type="file" name="Upload" class="upload-input" multiple />
            <button type="submit" class="btn btn-primary">Upload</button>
        </form>

        @if (!ViewData.ModelState.IsValid)
        {
            <div class="validation-errors">
                @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
                {
                    <p class="validation-error">@error.ErrorMessage</p>
                }
            </div>
        }
    </section>

    <!-- FILE GRID -->
    <section class="file-grid">
        @if (Model.Files != null && Model.Files.Any())
        {
            @foreach (var file in Model.Files)
            {
                <article class="file-card">
                    <!-- Top section: filetype colored header with large icon/label + filename -->
                    <div class="file-card-top @GetFileTypeClass(file.Name)">
                        <div class="file-card-top-inner">
                            <div class="file-thumb-large" aria-hidden="true">
                                <span class="file-icon-label">@System.IO.Path.GetExtension(file.Name).Replace(".", "").ToUpper()</span>
                            </div>
                            <div class="file-title" title="@file.Name">@file.Name</div>
                        </div>
                    </div>

                    <!-- Bottom section: meta + actions -->
                    <div class="file-card-bottom">
                        <div class="file-meta-left">
                            <div class="file-meta-text">
                                <div class="file-meta-owner">Uploaded af @file.UploadedBy.Name</div>
                                <div class="file-meta-date">@file.UploadedAt.ToString("d. MMM yyyy")</div>
                            </div>
                        </div>

                        <div class="file-meta-right">
                            <a asp-page-handler="Download"
                               asp-route-filePath="@file.FilePath"
                               class="btn btn-outline"
                               target="_blank"
                               rel="noopener">
                                Download
                            </a>

                            <form method="post"
                                  asp-page-handler="SoftDelete"
                                  class="inline-form">
                                <input type="hidden" name="filePath" value="@file.FilePath" />
                                <button type="submit" class="btn-link" title="Slet (flyt til papirkurv)">Slet</button>
                            </form>

                            @if (Model.IsAdmin)
                            {
                                <form method="post" asp-page-handler="Permissions" class="permissions-form">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="fileId" value="@file.ID" />

                                    <details>
                                        <summary class="btn btn-outline">Permissions</summary>

                                        <div class="permissions-dropdown">
                                            @foreach (var user in Model.AllUsers)
                                            {
                                                var isChecked = file.UsersWithPermission.Any(u => u.ID == user.ID);

                                                <label class="permission-item">
                                                    <input type="checkbox"
                                                           name="userIds"
                                                           value="@user.ID"
                                                           @(isChecked ? "checked" : "") />
                                                    @user.Name
                                                </label>
                                            }

                                            <button type="submit" class="btn btn-primary">Gem</button>
                                        </div>
                                    </details>
                                </form>
                            }
                        </div>
                    </div>
                </article>
            }
        }
        else
        {
            <p>Ingen filer endnu.</p>
        }
    </section>
</section>
